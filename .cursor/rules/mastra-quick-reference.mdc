---
description: 
globs: 
alwaysApply: false
---
# Mastraã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pnpm add @mastra/core@latest @ai-sdk/openai zod
pnpm add @mastra/loggers@latest @mastra/libsql@latest -D
```

### ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
# .env
OPENAI_API_KEY=your_openai_api_key
SLACK_BOT_TOKEN=xoxb-your-slack-token
GITLAB_ACCESS_TOKEN=glpat-your-gitlab-token
DATABASE_URL=file:./mastra.db
LOG_LEVEL=info
```

## ğŸ¤– ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

### åŸºæœ¬ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

```typescript
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";

export const myAgent = new Agent({
  name: "MyAgent",
  instructions: "ã‚ãªãŸã¯ã€œã§ã™ã€‚",
  model: openai("gpt-4o-mini"),
});
```

### ãƒ¡ãƒ¢ãƒªä»˜ãã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

```typescript
import { Memory } from "@mastra/memory";
import { LibSQLStore } from "@mastra/libsql";

const agent = new Agent({
  name: "MemoryAgent",
  instructions: "å±¥æ­´ã‚’è¨˜æ†¶ã—ã¾ã™ã€‚",
  model: openai("gpt-4o"),
  memory: new Memory({
    storage: new LibSQLStore({ url: "file:./memory.db" }),
  }),
});

// ä½¿ç”¨æ™‚
await agent.generate("è³ªå•", {
  resourceId: "user_123",
  threadId: "conversation_456",
});
```

### å‹•çš„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

```typescript
export const dynamicAgent = new Agent({
  name: "DynamicAgent",
  instructions: ({ runtimeContext }) => {
    const userType = runtimeContext.get("user-type");
    return userType === "admin" 
      ? "ç®¡ç†è€…å‘ã‘ã®æŒ‡ç¤º"
      : "ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®æŒ‡ç¤º";
  },
  model: ({ runtimeContext }) => {
    return runtimeContext.get("user-type") === "premium"
      ? openai("gpt-4o")
      : openai("gpt-4o-mini");
  },
});
```

## ğŸ”§ ãƒ„ãƒ¼ãƒ«

### åŸºæœ¬ãƒ„ãƒ¼ãƒ«

```typescript
import { createTool } from "@mastra/core/tools";
import { z } from "zod";

export const myTool = createTool({
  id: "my-tool-id",
  description: "ãƒ„ãƒ¼ãƒ«ã®èª¬æ˜",
  inputSchema: z.object({
    input: z.string().describe("å…¥åŠ›èª¬æ˜"),
  }),
  outputSchema: z.object({
    result: z.string(),
  }),
  execute: async ({ context }) => {
    return { result: `å‡¦ç†çµæœ: ${context.input}` };
  },
});
```

### APIé€£æºãƒ„ãƒ¼ãƒ«

```typescript
export const apiTool = createTool({
  id: "api-tool",
  description: "å¤–éƒ¨APIé€£æº",
  inputSchema: z.object({
    query: z.string(),
  }),
  execute: async ({ context, runtimeContext }) => {
    const apiKey = runtimeContext.get("api-key");
    
    const response = await fetch("https://api.example.com/data", {
      headers: { "Authorization": `Bearer ${apiKey}` },
      method: "POST",
      body: JSON.stringify({ query: context.query }),
    });
    
    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`);
    }
    
    return await response.json();
  },
});
```

## ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### åŸºæœ¬ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

```typescript
import { createWorkflow, createStep } from "@mastra/core/workflows";

const step1 = createStep({
  id: "step-1",
  inputSchema: z.object({ input: z.string() }),
  outputSchema: z.object({ output: z.string() }),
  execute: async ({ inputData }) => {
    return { output: `å‡¦ç†æ¸ˆã¿: ${inputData.input}` };
  },
});

export const myWorkflow = createWorkflow({
  id: "my-workflow",
  inputSchema: z.object({ input: z.string() }),
  outputSchema: z.object({ output: z.string() }),
  steps: [step1],
})
  .then(step1)
  .commit();
```

### ä¸¦åˆ—å®Ÿè¡Œ

```typescript
workflow
  .then(initialStep)
  .parallel([step2, step3])  // step2ã¨step3ã‚’ä¸¦åˆ—å®Ÿè¡Œ
  .then(finalStep)
  .commit();
```

### æ¡ä»¶åˆ†å²

```typescript
workflow
  .then(checkStep)
  .branch([
    [async ({ inputData }) => inputData.type === "A", stepA],
    [async ({ inputData }) => inputData.type === "B", stepB],
  ])
  .then(mergeStep)
  .commit();
```

### ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°

```typescript
workflow
  .then(step1)
  .map({
    newField: { step: step1, path: "oldField" },
    constant: { value: "å›ºå®šå€¤", schema: z.string() },
    fromInit: { initData: workflow, path: "initialValue" },
  })
  .then(step2)
  .commit();
```

## ğŸ“ å‹å®šç¾©

### åŸºæœ¬ã‚¹ã‚­ãƒ¼ãƒ

```typescript
import { z } from "zod";

// åŸºæœ¬çš„ãªå‹
const StringSchema = z.string().describe("æ–‡å­—åˆ—ã®èª¬æ˜");
const NumberSchema = z.number().min(0).max(100);
const BooleanSchema = z.boolean().default(false);

// ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
const UserSchema = z.object({
  id: z.string(),
  name: z.string(),
  email: z.string().email(),
  age: z.number().optional(),
});

// é…åˆ—
const UsersSchema = z.array(UserSchema);

// Enum
const StatusSchema = z.enum(["pending", "active", "inactive"]);

// Union
const ResponseSchema = z.union([
  z.object({ success: z.literal(true), data: z.any() }),
  z.object({ success: z.literal(false), error: z.string() }),
]);
```

### ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå‹

```typescript
export type MyRuntimeContext = {
  "user-id": string;
  "api-key": string;
  "debug-mode": boolean;
  "language": "ja" | "en";
};

// ä½¿ç”¨ä¾‹
const runtimeContext = new RuntimeContext<MyRuntimeContext>();
runtimeContext.set("user-id", "user123");
runtimeContext.set("language", "ja");
```

## ğŸ—ï¸ Mastraã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

### åŸºæœ¬è¨­å®š

```typescript
import { Mastra } from "@mastra/core";
import { PinoLogger } from "@mastra/loggers";
import { LibSQLStore } from "@mastra/libsql";

export const mastra = new Mastra({
  agents: { myAgent },
  workflows: { myWorkflow },
  storage: new LibSQLStore({ url: ":memory:" }),
  logger: new PinoLogger({ name: "App", level: "info" }),
});
```

### ã‚µãƒ¼ãƒãƒ¼ä»˜ãè¨­å®š

```typescript
export const mastra = new Mastra({
  agents: { myAgent },
  server: {
    host: "0.0.0.0",
    port: 4111,
    middleware: [
      async (c, next) => {
        console.log(`${c.req.method} ${c.req.url}`);
        await next();
      },
    ],
    apiRoutes: [
      {
        path: "/api/custom",
        method: "POST",
        createHandler: async ({ mastra }) => (c) => {
          const body = await c.req.json();
          return c.json({ received: body });
        },
      },
    ],
  },
});
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ

```typescript
import { describe, it, expect } from "@jest/globals";

describe("MyAgent", () => {
  it("should respond correctly", async () => {
    const result = await myAgent.generate("ãƒ†ã‚¹ãƒˆè³ªå•");
    expect(result.text).toBeDefined();
    expect(result.text.length).toBeGreaterThan(0);
  });
});
```

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ

```typescript
describe("MyWorkflow", () => {
  it("should complete successfully", async () => {
    const run = myWorkflow.createRun();
    const result = await run.start({
      inputData: { input: "ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿" },
    });
    
    expect(result.status).toBe("success");
    expect(result.result).toBeDefined();
  });
});
```

## ğŸ› ï¸ é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npx mastra dev

# ãƒ“ãƒ«ãƒ‰
npx mastra build

# å‹ãƒã‚§ãƒƒã‚¯
npx tsc --noEmit

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npx jest

# ãƒ­ã‚°ç¢ºèªï¼ˆé–‹ç™ºæ™‚ï¼‰
tail -f logs/mastra.log
```

## ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹

```typescript
export class MastraAppError extends Error {
  constructor(
    message: string,
    public readonly code: string,
    public readonly context?: Record<string, any>
  ) {
    super(message);
    this.name = "MastraAppError";
  }
}

// ä½¿ç”¨ä¾‹
throw new MastraAppError(
  "GitLab APIæ¥ç¶šã‚¨ãƒ©ãƒ¼",
  "GITLAB_CONNECTION_ERROR",
  { projectId: "123", statusCode: 403 }
);
```

### ãƒ„ãƒ¼ãƒ«ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
export const safeTool = createTool({
  id: "safe-tool",
  description: "å®‰å…¨ãªãƒ„ãƒ¼ãƒ«",
  inputSchema: z.object({ input: z.string() }),
  execute: async ({ context }) => {
    try {
      // ãƒªã‚¹ã‚¯ã®ã‚ã‚‹å‡¦ç†
      const result = await riskyOperation(context.input);
      return { success: true, data: result };
    } catch (error) {
      console.error("Tool execution failed:", error);
      return { 
        success: false, 
        error: error instanceof Error ? error.message : "Unknown error" 
      };
    }
  },
});
```

## ğŸ“Š ãƒ­ã‚°è¨­å®š

### æ§‹é€ åŒ–ãƒ­ã‚°

```typescript
import { PinoLogger } from "@mastra/loggers";

export const logger = new PinoLogger({
  name: "MyApp",
  level: "info",
  formatters: {
    log: (object) => ({
      ...object,
      timestamp: new Date().toISOString(),
      service: "requirement-automation",
    }),
  },
});

// ä½¿ç”¨ä¾‹
logger.info("Workflow started", { workflowId: "abc123" });
logger.error("Process failed", { error: error.message, context });
```

## ğŸ” ãƒ‡ãƒãƒƒã‚°

### å®Ÿè¡ŒçŠ¶æ³ç¢ºèª

```typescript
// ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®ç›£è¦–
const run = workflow.createRun();

run.watch((event) => {
  console.log("ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹:", event.payload.workflowState.status);
  if (event.payload.currentStep) {
    console.log("ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—:", event.payload.currentStep.id);
  }
});

const result = await run.start({ inputData: { ... } });
```

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡ŒçŠ¶æ³

```typescript
const result = await agent.generate("è³ªå•", {
  maxSteps: 5,
  onStepFinish: ({ text, toolCalls, toolResults }) => {
    console.log("ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†:", { text, toolCalls, toolResults });
  },
});
```

## ğŸ“± MCP (Model Context Protocol)

### MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

```typescript
import { MCPClient } from "@mastra/mcp";

const mcp = new MCPClient({
  servers: {
    filesystem: {
      command: "npx",
      args: ["-y", "@modelcontextprotocol/server-filesystem", "/path"],
    },
    weather: {
      url: new URL("http://localhost:8080/mcp"),
    },
  },
});

// é™çš„ãƒ„ãƒ¼ãƒ«å–å¾—
const tools = await mcp.getTools();

// å‹•çš„ãƒ„ãƒ¼ãƒ«å–å¾—
const toolsets = await mcp.getToolsets();
```

### MCPã‚µãƒ¼ãƒãƒ¼

```typescript
import { MCPServer } from "@mastra/mcp";

const server = new MCPServer({
  name: "My MCP Server",
  version: "1.0.0",
  tools: { myTool },
  agents: { myAgent },  // ask_myAgent ã¨ã—ã¦å…¬é–‹
  workflows: { myWorkflow },  // run_myWorkflow ã¨ã—ã¦å…¬é–‹
});

// stdio ã§èµ·å‹•
await server.startStdio();
```

## ğŸ”§ ã‚ˆãä½¿ç”¨ã•ã‚Œã‚‹è¨­å®š

### package.json scripts

```json
{
  "scripts": {
    "dev": "mastra dev",
    "build": "mastra build",
    "start": "node dist/index.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "type-check": "tsc --noEmit",
    "lint": "eslint src/**/*.ts",
    "format": "prettier --write src/**/*.ts"
  }
}
```

### tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "bundler",
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "skipLibCheck": true,
    "outDir": "dist"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", ".mastra"]
}
```

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | è§£æ±ºæ–¹æ³• |
|--------|------|----------|
| `Agent not found` | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒMastraã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ | `mastra.agents` ã«è¿½åŠ  |
| `Tool schema validation failed` | ãƒ„ãƒ¼ãƒ«ã®å…¥åŠ›ã‚¹ã‚­ãƒ¼ãƒãŒä¸æ­£ | Zodã‚¹ã‚­ãƒ¼ãƒã‚’ç¢ºèª |
| `Workflow step type mismatch` | ã‚¹ãƒ†ãƒƒãƒ—é–“ã®å‹ãŒä¸€è‡´ã—ãªã„ | `inputSchema` ã¨ `outputSchema` ã‚’ç¢ºèª |
| `Memory context required` | ãƒ¡ãƒ¢ãƒªä½¿ç”¨æ™‚ã« `resourceId` æœªæŒ‡å®š | `generate()` ã« `resourceId` ã¨ `threadId` ã‚’è¿½åŠ  |

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

```typescript
// ä¸¦åˆ—å®Ÿè¡Œã®æ´»ç”¨
workflow.parallel([step1, step2, step3])

// é©åˆ‡ãªãƒ¢ãƒ‡ãƒ«é¸æŠ
const model = complexity === "high" ? openai("gpt-4o") : openai("gpt-4o-mini");

// ãƒ„ãƒ¼ãƒ«ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
const response = await fetch(url, { 
  signal: AbortSignal.timeout(30000) 
});
```

---

ã“ã®ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’æ‰‹å…ƒã«ç½®ã„ã¦ã€åŠ¹ç‡çš„ãªMastraé–‹ç™ºã‚’é€²ã‚ã¦ãã ã•ã„ï¼ 